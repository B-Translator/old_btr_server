#!/bin/bash -ex
# executed after apply-overlay

### put the cache on RAM (to improve efficiency)
sed -e '/^tmpfs/d' -i /etc/fstab
cat <<EOF >> /etc/fstab
tmpfs		/dev/shm	tmpfs	defaults,noexec,nosuid	0	0
tmpfs		/usr/local/share/btranslator/cache	tmpfs	defaults,size=5M,mode=0777,noexec,nosuid	0	0
EOF

### create a link to sites-enabled for the nginx config of btranslator
ln -sf /etc/nginx/sites-{available,enabled}/btranslator

### create some dirs that are needed
mkdir -p /var/www/downloads/
mkdir -p /var/run/memcached/

# install uploadprogress bar (from PECL) (requested by Drupal 7)
pecl install uploadprogress
echo "extension = uploadprogress.so" > /etc/php5/conf.d/uploadprogress.ini

# Protect Drupal settings from prying eyes
SETTINGS=/usr/local/share/btranslator/sites/default/settings.php
chown root:www-data $SETTINGS
chmod 640 $SETTINGS

# Disable Poor Man's Cron
cat >> $SETTINGS << EOF

/**
 * Disable Poor Man's Cron:
 *
 * Drupal 7 enables the built-in Poor Man's Cron by default.
 * Poor Man's Cron relies on site activity to trigger Drupal's cron,
 * and is not well suited for low activity websites.
 *
 * We will use the Linux system cron and override Poor Man's Cron
 * by setting the cron_safe_threshold to 0.
 *
 * To re-enable Poor Man's Cron:
 *    Comment out (add a leading hash sign) the line below,
 *    and the system cron in /etc/cron.d/drupal7.
 */
\$conf['cron_safe_threshold'] = 0;
EOF

# disable powered-by Drupal block on all themes
mysql -e "USE btranslator; UPDATE block SET status = '0' WHERE ( module = 'system' AND delta = 'powered-by' );"

# change turnkey version
echo 'turnkey-btranslator-drupal7-nginx-12.0-squeeze-x86' > /etc/turnkey_version

# tell the world what we've done!
echo 'TurnKey B-Translator (Drupal7+NGINX) Appliance' >> /etc/issue
